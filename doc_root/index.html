<html>
<head>
<link rel="stylesheet" href="css/style.css" type="text/css" />
<script language="javascript" src="js/jquery-1.2.6.js"></script>
<script language="javascript" src="js/jquery.dimensions.js"></script>
<script language="javascript" src="js/jquery.easydrag.js"></script>
<script language="javascript" src="js/json2.js"></script>
<script language="javascript" src="js/JSORB.js"></script>
<script language="javascript">

var c = new JSORB.Client ({
    base_url       : 'http://localhost:9999/',
    base_namespace : '/kiokudb/navigator/'
});

function lookup (id, callback) {
    c.call(
        { method : 'lookup', params : [ id ] },
        callback
    );
}

$(document).ready(function () {
    $('.widget_control').toggle(
        function () {
            $(this).html("&#x2193;");
            $(this).parent().find('.widget_container').hide();
        },
        function () {
            $(this).html("&#x2191;");
            $(this).parent().find('.widget_container').show();
        }
    );

});


function create_object_link (ref_id, label) {
    if (ref_id.indexOf('.data') != -1) {
        ref_id = ref_id.substring(0, ref_id.indexOf('.data'));
    }
    return '<a id="' + ref_id + '" class="loader" href="javascript:void(0)">'
         + label
         + '</a><ul class="hidden"></ul>';
}

function is_ref_id (id) {
    if (id.indexOf('-') == 8 && id.lastIndexOf('-') == 23) {
        return true;
    }
    return false;
}

function create_object_repr (obj) {
    var out = '';
    for (var prop in obj) {
        if (prop == '$ref') {
            out += create_object_link( obj[prop], '[ + ]' );
        }
        else {
            out += '<li><div class="label">' + prop + '</div><div class="value">';
            switch (obj[prop].constructor) {
                case Object:
                    out += '<ul>' + create_object_repr( obj[prop] ) + '</ul>';
                    break;
                case Array:
                    out += '<ul class="collection">';
                    for (var i = 0; i < obj[prop].length; i++) {
                        switch (obj[prop][i].constructor) {
                            case Object:
                                out += '<li><div class="value">'
                                if (obj[prop][i]['$ref'] == undefined) {
                                    out += '<ul>' + create_object_repr( obj[prop][i] ) + '</ul>';
                                }
                                else {
                                    out += create_object_link( obj[prop][i]['$ref'], '[ ' + i + ' ]' );
                                }
                                out += '</div></li>';
                                break;
                            case String:
                                if (is_ref_id(obj[prop][i])) {
                                    out += "<div>" + create_object_link( obj[prop][i], '[ ' + i + ' ]' ) + "</div>";
                                }
                                else {
                                    out += "<div>" + obj[prop][i] + "</div>";
                                }
                                break;
                        }
                    }
                    out += '</ul>';
                    break;
                default:
                    if (prop == 'id') {
                        out += obj[prop]
                            + '&nbsp;<a href="#" onclick="load_object( undefined, \''
                            + obj[prop]
                            + '\')">[ â‡— ]</a>';
                    }
                    else {
                        out += obj[prop];
                    }
            }
            out += "</div></li>"
        }
    }
    return out;
}

function load_object (container, id) {

    if (container == undefined) {
        var holder = $(
            '<div class="navigator_container">'
            + '<div class="navigator_handle">'
            + '<a href="#" onclick="$(this).parent().parent().remove()">[ x ]</a>&nbsp;'
            + (id == '' ? 'root' : id)
            + '</div>'
            + '<ul class="object_container" id="' + id + '"></ul>'
            + '</div>'
        );

        $(document.body).append(holder);

        $('.navigator_handle', holder).toggle(
            function () { $('.object_container', $(this).parent()).hide() },
            function () { $('.object_container', $(this).parent()).show() }
        );

        container = $('.object_container', holder);
    }

    lookup(id, function (obj) {
        $(container).html( create_object_repr( obj ) );

        $('.loader', container).click(function () {
            var id = $(this).attr('id');
            load_object( $(this).siblings('ul'), id );
            $(this).siblings('ul').removeClass('hidden');
            $(this).unbind('click');
            $(this).click(function () {
                $(this).siblings('ul').toggle()
            });
        })
    });
}


</script>
</head>
<body>
<div class="widget">
    <div class="widget_container">
        <div class="widget_label">Lookup By ID</div>
        <input type="text" id="lookup" size="36" />
        <input type="button" value="lookup" onclick="load_object( undefined, $('#lookup').val() )" />
    </div>
    <div class="widget_control">&#x2191;</div>
</div>
</body>
</html>